---
# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: volumes volumes
templates:
  - entrypoint.yaml
values:
  - ../_values/workloads_main_default_container.yaml
tests:
  - it: no volumes should pass
    asserts:
      - documentIndex: &DeploymentDoc 0
        isKind:
          of: Deployment
      - documentIndex: *DeploymentDoc
        notExists:
          path: spec.template.spec.volumes

  - it: default should pass
    set:
      volumes:
        config:
          accessMode: ReadWriteOnce
          size: 1Gi
    asserts:
      - documentIndex: &DeploymentDoc 1
        isKind:
          of: Deployment
      - documentIndex: *DeploymentDoc
        equal:
          path: spec.template.spec.volumes
          value:
            - name: config
              persistentVolumeClaim:
                claimName: RELEASE-NAME-config

  - it: advanced mount config should pass
    set:
      workloads:
        main:
          containers:
            second-container:
              image:
                name: ghcr.io/mendhak/http-https-echo
                tag: 31
        second:
          containers:
            first-container:
              image:
                name: ghcr.io/mendhak/http-https-echo
                tag: 31

      volumes:
        config:
          existingClaim: test
          advancedMounts:
            main:
              main:
                - path: /config
                  readOnly: false
        data:
          type: configMap
          name: myConfigMap
          globalMounts:
            - path: /globalTest
          advancedMounts:
            main:
              main:
                - path: /data/config.yaml
                  readOnly: false
                  subPath: config.yaml
              second-container:
                - path: /appdata/config
                  readOnly: true
            second:
              first-container:
                - path: /second-pod/config.yaml
                  readOnly: false
                  subPath: config.yaml
        no-mounts:
          existingClaim: test-claim

    asserts:
      - documentSelector: &FirstDeploymentSelector
          path: $[?(@.kind == "Deployment")].metadata.name
          value: RELEASE-NAME-main
        isKind:
          of: Deployment
      - documentSelector: *FirstDeploymentSelector
        equal:
          path: spec.template.spec.volumes
          value:
            - name: config
              persistentVolumeClaim:
                claimName: test
            - configMap:
                name: myConfigMap
              name: data
            - name: no-mounts
              persistentVolumeClaim:
                claimName: test-claim
      - documentSelector: &SecondDeploymentSelector
          path: $[?(@.kind == "Deployment")].metadata.name
          value: RELEASE-NAME-second
        isKind:
          of: Deployment
      - documentSelector: *SecondDeploymentSelector
        equal:
          path: spec.template.spec.volumes
          value:
            - configMap:
                name: myConfigMap
              name: data
            - name: no-mounts
              persistentVolumeClaim:
                claimName: test-claim